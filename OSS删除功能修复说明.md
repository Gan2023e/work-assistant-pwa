# OSS删除功能修复说明

## 问题描述

在"采购发票管理"页面中，"删除发票"和"删除截图"功能无法成功从阿里云OSS中删除文件。

## 问题根源分析

### 1. 删除截图问题
- **原因**：后端使用错误的字段名（`screenshot.uid`）作为OSS对象名进行删除
- **实际情况**：`screenshot.uid` 只是前端Upload组件生成的随机ID，不是OSS中的实际对象名
- **缺失信息**：前端在保存截图数据时没有包含OSS对象名字段

### 2. 删除发票文件问题
- **原因**：缺少OSS对象名的专门存储字段，只能从URL解析
- **风险**：URL格式变化或代理URL无法提取正确的对象名

## 修复方案

### 1. 数据库结构改进
- 为`invoices`表添加了`invoice_file_object_name`字段，专门存储OSS对象名
- 这样删除时可以直接使用数据库中的对象名，而不依赖URL解析

### 2. 前端修复
- **截图上传**：在构造截图数据时，添加了`objectName`字段保存后端返回的OSS对象名
- **发票上传**：在PDF解析后的表单数据中添加了`invoice_file_object_name`字段
- **表单字段**：添加了隐藏的`invoice_file_object_name`表单字段

### 3. 后端修复
- **删除截图逻辑**：改进了对象名获取逻辑，优先使用`objectName`字段，其次从URL解析
- **删除发票逻辑**：优先使用数据库中保存的`invoice_file_object_name`，其次从URL解析
- **文件上传**：在保存发票文件信息时，同时保存OSS对象名

## 具体修改内容

### 1. 数据库迁移
```sql
ALTER TABLE invoices 
ADD COLUMN invoice_file_object_name VARCHAR(500) NULL COMMENT '发票文件OSS对象名称' 
AFTER invoice_file_url
```

### 2. 前端修改
- `PurchaseInvoice.tsx`：修复截图数据保存和发票表单字段

### 3. 后端修改
- `purchaseInvoice.js`：改进删除逻辑和文件信息保存
- `Invoice.js`：添加新字段定义

## 测试方法

### 测试删除发票功能
1. 上传一个包含PDF文件的发票
2. 确认发票在OSS中成功存储
3. 点击"删除发票"按钮
4. 检查OSS中的文件是否被成功删除
5. 检查数据库中的发票记录是否被删除
6. 检查相关订单状态是否重置为"未开票"

### 测试删除截图功能
1. 创建一个发票，上传金额差异截图
2. 确认截图在OSS中成功存储
3. 点击"删除截图"按钮
4. 检查OSS中的截图文件是否被成功删除
5. 检查数据库中的截图信息是否被清除

### 验证日志
在后端控制台查看相关日志：
- `✅ 删除OSS截图文件成功: [对象名]`
- `✅ OSS文件删除成功: [对象名]`
- `📋 使用数据库中保存的对象名: [对象名]`

## 向后兼容性

- 对于新上传的文件，会正确保存OSS对象名
- 对于历史数据（没有对象名的），仍然尝试从URL解析
- 不会影响现有功能的正常使用

## 注意事项

1. 确保OSS配置正确，包括删除权限
2. 删除操作会记录详细日志，便于排查问题
3. 即使OSS删除失败，数据库操作仍会继续，不会阻塞业务流程
4. 新字段为可空字段，不影响历史数据

## 启动测试

后端和前端服务器已启动，可以登录系统进行测试：
- 前端：http://localhost:3000
- 后端：http://localhost:3001

请测试以下功能：
1. 上传发票PDF并创建发票
2. 删除发票，检查OSS文件是否被删除
3. 上传金额差异截图
4. 删除截图，检查OSS文件是否被删除 