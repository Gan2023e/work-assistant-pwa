import React, { useState, useEffect } from 'react';
import {
  Table,
  Input,
  Button,
  Space,
  Card,
  Form,
  Modal,
  message,
  Popconfirm,
  Row,
  Col,
  Tag,
  Tooltip,
  Typography,
  Select,
  Divider,
  Badge,
  Empty,
  Descriptions
} from 'antd';
import {
  SearchOutlined,
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  ExportOutlined,
  ReloadOutlined,
  EnvironmentOutlined,
  UserOutlined,
  PhoneOutlined,
  InfoCircleOutlined,
  FilterOutlined,
  ClearOutlined,
  HomeOutlined,
  GlobalOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined
} from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import dayjs from 'dayjs';
import { API_BASE_URL } from '../../config/api';

const { TextArea } = Input;
const { Title, Text, Paragraph } = Typography;
const { Option } = Select;

// ‰∫öÈ©¨ÈÄä‰ªìÂ∫ìÊé•Âè£ÂÆö‰πâ
interface AmzWarehouse {
  warehouse_code: string;
  recipient_name: string;
  address_line1: string;
  address_line2?: string;
  city: string;
  state_province?: string;
  postal_code: string;
  country: string;
  phone?: string;
  status: 'active' | 'inactive';
  notes?: string;
  created_at?: string;
  updated_at?: string;
}

const WarehouseManagement: React.FC = () => {
  const [data, setData] = useState<AmzWarehouse[]>([]);
  const [filteredData, setFilteredData] = useState<AmzWarehouse[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [viewModalVisible, setViewModalVisible] = useState(false);
  const [editingRecord, setEditingRecord] = useState<AmzWarehouse | null>(null);
  const [viewingRecord, setViewingRecord] = useState<AmzWarehouse | null>(null);
  const [showAdvancedSearch, setShowAdvancedSearch] = useState(false);
  
  const [form] = Form.useForm();
  const [searchForm] = Form.useForm();

  // Ëé∑Âèñ‰ªìÂ∫ìÂàóË°®
  const fetchWarehouses = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE_URL}/api/warehouse`);
      const result = await response.json();
      
      if (result.code === 0) {
        setData(result.data);
        setFilteredData(result.data);
        message.success(`‚úÖ Âä†ËΩΩ‰∫Ü ${result.data.length} ‰∏™‰ªìÂ∫ìÂú∞ÂùÄ`);
      } else {
        throw new Error(result.message || 'Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('‚ùå Ëé∑Âèñ‰ªìÂ∫ìÂàóË°®Â§±Ë¥•:', error);
      message.error(`Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
      setData([]);
      setFilteredData([]);
    } finally {
      setLoading(false);
    }
  };

  // ‰øùÂ≠ò‰ªìÂ∫ì
  const handleSaveWarehouse = async (values: AmzWarehouse) => {
    try {
      const isEditing = !!editingRecord;
      const url = isEditing 
        ? `${API_BASE_URL}/api/warehouse/${encodeURIComponent(editingRecord!.warehouse_code)}`
        : `${API_BASE_URL}/api/warehouse`;
      const method = isEditing ? 'PUT' : 'POST';

      console.log(`üîÑ ${isEditing ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫'}‰ªìÂ∫ì:`, values);

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values)
      });

      const result = await response.json();
      
      if (result.code === 0) {
        message.success(`‚úÖ ${isEditing ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫'}ÊàêÂäü`);
        setEditModalVisible(false);
        setEditingRecord(null);
        form.resetFields();
        await fetchWarehouses();
      } else {
        throw new Error(result.message || 'Êìç‰ΩúÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('‚ùå ‰øùÂ≠ò‰ªìÂ∫ìÂ§±Ë¥•:', error);
      message.error(`Êìç‰ΩúÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
    }
  };

  // Âà†Èô§‰ªìÂ∫ì
  const handleDeleteWarehouse = async (warehouseCode: string) => {
    try {
      console.log('üóëÔ∏è Âà†Èô§‰ªìÂ∫ì:', warehouseCode);
      const response = await fetch(`${API_BASE_URL}/api/warehouse/${encodeURIComponent(warehouseCode)}`, {
        method: 'DELETE'
      });

      const result = await response.json();
      
      if (result.code === 0) {
        message.success('‚úÖ Âà†Èô§ÊàêÂäü');
        await fetchWarehouses();
      } else {
        throw new Error(result.message || 'Âà†Èô§Â§±Ë¥•');
      }
    } catch (error) {
      console.error('‚ùå Âà†Èô§‰ªìÂ∫ìÂ§±Ë¥•:', error);
      message.error(`Âà†Èô§Â§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
    }
  };

  // ÊâπÈáèÂà†Èô§
  const handleBatchDelete = async () => {
    if (selectedRowKeys.length === 0) {
      message.warning('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑ‰ªìÂ∫ì');
      return;
    }

    Modal.confirm({
      title: 'ÊâπÈáèÂà†Èô§Á°ÆËÆ§',
      content: `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedRowKeys.length} ‰∏™‰ªìÂ∫ìÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
      okText: 'Á°ÆÂÆöÂà†Èô§',
      okType: 'danger',
      cancelText: 'ÂèñÊ∂à',
      onOk: async () => {
        try {
          const promises = selectedRowKeys.map(key => 
            fetch(`${API_BASE_URL}/api/warehouse/${encodeURIComponent(key as string)}`, {
              method: 'DELETE'
            })
          );
          
          await Promise.all(promises);
          message.success(`‚úÖ ÊàêÂäüÂà†Èô§ ${selectedRowKeys.length} ‰∏™‰ªìÂ∫ì`);
          setSelectedRowKeys([]);
          await fetchWarehouses();
        } catch (error) {
          message.error('‚ùå ÊâπÈáèÂà†Èô§Â§±Ë¥•');
        }
      }
    });
  };

  // ÊêúÁ¥¢Â§ÑÁêÜ
  const handleSearch = (params: any) => {
    let filtered = [...data];
    
    if (params.search) {
      const searchLower = params.search.toLowerCase();
      filtered = filtered.filter(item =>
        item.warehouse_code.toLowerCase().includes(searchLower) ||
        item.recipient_name.toLowerCase().includes(searchLower) ||
        item.address_line1.toLowerCase().includes(searchLower) ||
        item.city.toLowerCase().includes(searchLower) ||
        item.country.toLowerCase().includes(searchLower) ||
        (item.postal_code && item.postal_code.toLowerCase().includes(searchLower))
      );
    }
    
    if (params.status) {
      filtered = filtered.filter(item => item.status === params.status);
    }
    
    if (params.country) {
      filtered = filtered.filter(item => item.country === params.country);
    }
    
    setFilteredData(filtered);
  };

  // ÈáçÁΩÆÊêúÁ¥¢
  const handleResetSearch = () => {
    setFilteredData(data);
    searchForm.resetFields();
  };

  // ÂØºÂá∫Êï∞ÊçÆ
  const handleExport = () => {
    const csvContent = [
      ['‰ªìÂ∫ì‰ª£Á†Å', 'Êî∂‰ª∂‰∫∫', 'Âú∞ÂùÄ‰∏Ä', 'Âú∞ÂùÄ‰∫å', 'ÂüéÂ∏Ç', 'Â∑û/ÁúÅ', 'ÈÇÆÁºñ', 'ÂõΩÂÆ∂', 'ÁîµËØù', 'Áä∂ÊÄÅ', 'Â§áÊ≥®', 'ÂàõÂª∫Êó∂Èó¥'].join(','),
      ...filteredData.map(item => [
        item.warehouse_code,
        item.recipient_name,
        item.address_line1,
        item.address_line2 || '',
        item.city,
        item.state_province || '',
        item.postal_code,
        item.country,
        item.phone || '',
        item.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®',
        item.notes || '',
        item.created_at ? dayjs(item.created_at).format('YYYY-MM-DD HH:mm:ss') : ''
      ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `warehouses_${dayjs().format('YYYY-MM-DD')}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    message.success('üìä Êï∞ÊçÆÂØºÂá∫ÊàêÂäü');
  };

  // Ëé∑ÂèñÂîØ‰∏ÄÂõΩÂÆ∂ÂàóË°®
  const getUniqueCountries = () => {
    const countries = Array.from(new Set(data.map(item => item.country)));
    return countries.filter(Boolean).sort();
  };

  useEffect(() => {
    fetchWarehouses();
  }, []);

  // Ë°åÈÄâÊã©ÈÖçÁΩÆ
  const rowSelection = {
    selectedRowKeys,
    onChange: (newSelectedRowKeys: React.Key[]) => {
      setSelectedRowKeys(newSelectedRowKeys);
    },
  };

  // Ë°®Ê†ºÂàóÈÖçÁΩÆ
  const columns: ColumnsType<AmzWarehouse> = [
    {
      title: '‰ªìÂ∫ì‰ª£Á†Å',
      dataIndex: 'warehouse_code',
      key: 'warehouse_code',
      width: 120,
      fixed: 'left',
      render: (text: string) => (
        <Tag color="blue" style={{ fontWeight: 'bold', fontSize: '12px' }}>
          {text}
        </Tag>
      ),
    },
    {
      title: 'Êî∂‰ª∂‰∫∫',
      dataIndex: 'recipient_name',
      key: 'recipient_name',
      width: 120,
      render: (name: string) => (
        <Text strong>{name}</Text>
      ),
    },
    {
      title: 'Âú∞ÂùÄ',
      key: 'address',
      width: 300,
      render: (_, record) => (
        <div>
          <Text>{record.address_line1}</Text>
          {record.address_line2 && (
            <div>
              <Text type="secondary" style={{ fontSize: '12px' }}>
                {record.address_line2}
              </Text>
            </div>
          )}
          <div style={{ marginTop: 4 }}>
            <Space size="small">
              <Tag>{record.city}</Tag>
              {record.state_province && <Tag>{record.state_province}</Tag>}
              <Tag>{record.postal_code}</Tag>
            </Space>
          </div>
        </div>
      ),
    },
    {
      title: 'ÂõΩÂÆ∂',
      dataIndex: 'country',
      key: 'country',
      width: 100,
      align: 'center',
      render: (country: string) => (
        <Tag color="green">{country}</Tag>
      ),
    },
    {
      title: 'ÁîµËØù',
      dataIndex: 'phone',
      key: 'phone',
      width: 120,
      align: 'center',
      render: (phone: string) => (
        phone ? (
          <a href={`tel:${phone}`} style={{ color: '#1890ff' }}>
            {phone}
          </a>
        ) : '-'
      ),
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      width: 80,
      align: 'center',
      render: (status: string) => (
        <Tag 
          color={status === 'active' ? 'success' : 'error'}
          icon={status === 'active' ? <CheckCircleOutlined /> : <CloseCircleOutlined />}
        >
          {status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
        </Tag>
      ),
    },
    {
      title: 'ÂàõÂª∫Êó∂Èó¥',
      dataIndex: 'created_at',
      key: 'created_at',
      width: 100,
      align: 'center',
      render: (date: string) => (
        date ? dayjs(date).format('YYYY-MM-DD') : '-'
      ),
    },
    {
      title: 'Êìç‰Ωú',
      key: 'action',
      width: 150,
      fixed: 'right',
      render: (_, record) => (
        <Space size="small">
          <Tooltip title="Êü•ÁúãËØ¶ÊÉÖ">
            <Button
              type="text"
              icon={<InfoCircleOutlined />}
              onClick={() => {
                setViewingRecord(record);
                setViewModalVisible(true);
              }}
              size="small"
            />
          </Tooltip>
          <Tooltip title="ÁºñËæë">
            <Button
              type="text"
              icon={<EditOutlined />}
              onClick={() => {
                setEditingRecord(record);
                form.setFieldsValue(record);
                setEditModalVisible(true);
              }}
              size="small"
            />
          </Tooltip>
          <Popconfirm
            title="Á°ÆËÆ§Âà†Èô§"
            description={`Á°ÆÂÆöË¶ÅÂà†Èô§‰ªìÂ∫ì "${record.warehouse_code}" ÂêóÔºü`}
            onConfirm={() => handleDeleteWarehouse(record.warehouse_code)}
            okText="Á°ÆÂÆö"
            cancelText="ÂèñÊ∂à"
          >
            <Tooltip title="Âà†Èô§">
              <Button
                type="text"
                icon={<DeleteOutlined />}
                danger
                size="small"
              />
            </Tooltip>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div style={{ padding: '24px' }}>
      <Card>
        <div style={{ marginBottom: 24 }}>
          <Row justify="space-between" align="middle">
            <Col>
              <Title level={4} style={{ margin: 0 }}>
                <HomeOutlined style={{ marginRight: 8, color: '#1890ff' }} />
                ‰∫öÈ©¨ÈÄä‰ªìÂ∫ìÁÆ°ÁêÜ
              </Title>
              <Text type="secondary">
                ÁÆ°ÁêÜ‰∫öÈ©¨ÈÄä‰ªìÂ∫ìÂú∞ÂùÄ‰ø°ÊÅØÔºåÂåÖÊã¨Êî∂‰ª∂‰∫∫„ÄÅÂú∞ÂùÄÂíåËÅîÁ≥ªÊñπÂºè
              </Text>
            </Col>
            <Col>
              <Space>
                <Badge count={filteredData.filter(w => w.status === 'active').length} showZero>
                  <Button icon={<CheckCircleOutlined />} type="text" style={{ color: '#52c41a' }}>
                    ÂêØÁî®‰ªìÂ∫ì
                  </Button>
                </Badge>
                <Badge count={filteredData.length} showZero>
                  <Button icon={<InfoCircleOutlined />} type="text">
                    ÊÄª‰ªìÂ∫ìÊï∞
                  </Button>
                </Badge>
              </Space>
            </Col>
          </Row>
        </div>

        {/* ÊêúÁ¥¢Âå∫Âüü */}
        <Card size="small" style={{ marginBottom: 16 }}>
          <Form
            form={searchForm}
            layout="inline"
            onFinish={handleSearch}
            style={{ width: '100%' }}
          >
            <Form.Item name="search" style={{ minWidth: 250 }}>
              <Input
                prefix={<SearchOutlined />}
                placeholder="ÊêúÁ¥¢‰ªìÂ∫ì‰ª£Á†Å„ÄÅÊî∂‰ª∂‰∫∫„ÄÅÂú∞ÂùÄ..."
                allowClear
              />
            </Form.Item>
            
            {showAdvancedSearch && (
              <>
                <Form.Item name="status">
                  <Select placeholder="Á≠õÈÄâÁä∂ÊÄÅ" style={{ width: 120 }} allowClear>
                    <Option value="active">ÂêØÁî®</Option>
                    <Option value="inactive">Á¶ÅÁî®</Option>
                  </Select>
                </Form.Item>
                <Form.Item name="country">
                  <Select placeholder="Á≠õÈÄâÂõΩÂÆ∂" style={{ width: 120 }} allowClear>
                    {getUniqueCountries().map(country => (
                      <Option key={country} value={country}>{country}</Option>
                    ))}
                  </Select>
                </Form.Item>
              </>
            )}
            
            <Form.Item>
              <Space>
                <Button type="primary" htmlType="submit" icon={<SearchOutlined />}>
                  ÊêúÁ¥¢
                </Button>
                <Button onClick={handleResetSearch} icon={<ClearOutlined />}>
                  ÈáçÁΩÆ
                </Button>
                <Button
                  type="text"
                  icon={<FilterOutlined />}
                  onClick={() => setShowAdvancedSearch(!showAdvancedSearch)}
                >
                  {showAdvancedSearch ? 'Êî∂Ëµ∑' : 'È´òÁ∫ß'}
                </Button>
              </Space>
            </Form.Item>
          </Form>
        </Card>

        {/* Êìç‰ΩúÂ∑•ÂÖ∑Ê†è */}
        <div style={{ marginBottom: 16 }}>
          <Row justify="space-between">
            <Col>
              <Space>
                <Button 
                  type="primary" 
                  icon={<PlusOutlined />} 
                  onClick={() => {
                    setEditingRecord(null);
                    form.resetFields();
                    form.setFieldsValue({ status: 'active' });
                    setEditModalVisible(true);
                  }}
                >
                  Êñ∞Â¢û‰ªìÂ∫ì
                </Button>
                <Button 
                  icon={<ReloadOutlined />} 
                  onClick={fetchWarehouses}
                  loading={loading}
                >
                  Âà∑Êñ∞
                </Button>
                {selectedRowKeys.length > 0 && (
                  <Button 
                    danger 
                    icon={<DeleteOutlined />} 
                    onClick={handleBatchDelete}
                  >
                    ÊâπÈáèÂà†Èô§ ({selectedRowKeys.length})
                  </Button>
                )}
              </Space>
            </Col>
            <Col>
              <Button 
                icon={<ExportOutlined />} 
                onClick={handleExport}
                disabled={filteredData.length === 0}
              >
                ÂØºÂá∫Êï∞ÊçÆ
              </Button>
            </Col>
          </Row>
        </div>

        {/* Êï∞ÊçÆË°®Ê†º */}
        <Table
          rowSelection={rowSelection}
          columns={columns}
          dataSource={filteredData}
          rowKey="warehouse_code"
          loading={loading}
          size="small"
          scroll={{ x: 1200, y: 600 }}
          pagination={{
            defaultPageSize: 20,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `Á¨¨ ${range?.[0]}-${range?.[1]} Êù°ÔºåÂÖ± ${total} ‰∏™‰ªìÂ∫ì`,
            pageSizeOptions: ['10', '20', '50', '100'],
          }}
          locale={{
            emptyText: (
              <Empty
                image={Empty.PRESENTED_IMAGE_SIMPLE}
                description="ÊöÇÊó†‰ªìÂ∫ìËÆ∞ÂΩï"
              />
            )
          }}
        />
      </Card>

      {/* ÁºñËæë/Êñ∞Â¢ûÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={
          <Space>
            {editingRecord ? <EditOutlined /> : <PlusOutlined />}
            {editingRecord ? 'ÁºñËæë‰ªìÂ∫ì‰ø°ÊÅØ' : 'Êñ∞Â¢û‰ªìÂ∫ì'}
          </Space>
        }
        open={editModalVisible}
        onCancel={() => {
          setEditModalVisible(false);
          setEditingRecord(null);
          form.resetFields();
        }}
        footer={null}
        width={800}
        destroyOnClose
      >
        <Divider />
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSaveWarehouse}
          initialValues={{
            status: 'active'
          }}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="warehouse_code"
                label="‰ªìÂ∫ì‰ª£Á†Å"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•‰ªìÂ∫ì‰ª£Á†Å' },
                  { max: 50, message: '‰ªìÂ∫ì‰ª£Á†ÅÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•‰ªìÂ∫ì‰ª£Á†Å" 
                  disabled={!!editingRecord}
                  maxLength={50}
                />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="recipient_name"
                label="Êî∂‰ª∂‰∫∫"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•Êî∂‰ª∂‰∫∫ÂßìÂêç' },
                  { max: 100, message: 'Êî∂‰ª∂‰∫∫ÂßìÂêçÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•Êî∂‰ª∂‰∫∫ÂßìÂêç" 
                  prefix={<UserOutlined />}
                  maxLength={100}
                />
              </Form.Item>
            </Col>
          </Row>
          
          <Form.Item
            name="address_line1"
            label="Âú∞ÂùÄ‰∏Ä"
            rules={[
              { required: true, message: 'ËØ∑ËæìÂÖ•Âú∞ÂùÄ‰∏Ä' },
              { max: 200, message: 'Âú∞ÂùÄÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá200‰∏™Â≠óÁ¨¶' }
            ]}
          >
            <Input 
              placeholder="ËØ∑ËæìÂÖ•‰∏ªË¶ÅÂú∞ÂùÄ" 
              prefix={<EnvironmentOutlined />}
              maxLength={200}
            />
          </Form.Item>

          <Form.Item
            name="address_line2"
            label="Âú∞ÂùÄ‰∫å"
            rules={[
              { max: 200, message: 'Âú∞ÂùÄÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá200‰∏™Â≠óÁ¨¶' }
            ]}
          >
            <Input 
              placeholder="ËØ∑ËæìÂÖ•Ë°•ÂÖÖÂú∞ÂùÄÔºàÂèØÈÄâÔºâ" 
              prefix={<EnvironmentOutlined />}
              maxLength={200}
            />
          </Form.Item>

          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                name="city"
                label="ÂüéÂ∏Ç"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•ÂüéÂ∏Ç' },
                  { max: 100, message: 'ÂüéÂ∏ÇÂêçÁß∞ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•ÂüéÂ∏Ç" 
                  maxLength={100}
                />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="state_province"
                label="Â∑û/ÁúÅ"
                rules={[
                  { max: 100, message: 'Â∑û/ÁúÅÂêçÁß∞ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•Â∑û/ÁúÅ" 
                  maxLength={100}
                />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="postal_code"
                label="ÈÇÆÁºñ"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•ÈÇÆÁºñ' },
                  { max: 20, message: 'ÈÇÆÁºñÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁºñ" 
                  maxLength={20}
                />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="country"
                label="ÂõΩÂÆ∂"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•ÂõΩÂÆ∂' },
                  { max: 100, message: 'ÂõΩÂÆ∂ÂêçÁß∞ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•ÂõΩÂÆ∂" 
                  prefix={<GlobalOutlined />}
                  maxLength={100}
                />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="phone"
                label="ÁîµËØù"
                rules={[
                  { max: 50, message: 'ÁîµËØùÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input 
                  placeholder="ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù" 
                  prefix={<PhoneOutlined />}
                  maxLength={50}
                />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="status"
                label="Áä∂ÊÄÅ"
                rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Áä∂ÊÄÅ' }]}
              >
                <Select placeholder="ÈÄâÊã©‰ªìÂ∫ìÁä∂ÊÄÅ">
                  <Option value="active">
                    <Space>
                      <CheckCircleOutlined style={{ color: '#52c41a' }} />
                      ÂêØÁî®
                    </Space>
                  </Option>
                  <Option value="inactive">
                    <Space>
                      <CloseCircleOutlined style={{ color: '#ff4d4f' }} />
                      Á¶ÅÁî®
                    </Space>
                  </Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="notes"
            label="Â§áÊ≥®"
            rules={[
              { max: 500, message: 'Â§áÊ≥®ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá500‰∏™Â≠óÁ¨¶' }
            ]}
          >
            <TextArea 
              rows={3} 
              placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ" 
              maxLength={500}
              showCount
            />
          </Form.Item>

          <Divider />
          
          <Form.Item style={{ marginBottom: 0, textAlign: 'right' }}>
            <Space>
              <Button onClick={() => {
                setEditModalVisible(false);
                setEditingRecord(null);
                form.resetFields();
              }}>
                ÂèñÊ∂à
              </Button>
              <Button type="primary" htmlType="submit">
                {editingRecord ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫'}
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>

      {/* Êü•ÁúãËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={
          <Space>
            <InfoCircleOutlined />
            ‰ªìÂ∫ìËØ¶ÁªÜ‰ø°ÊÅØ
          </Space>
        }
        open={viewModalVisible}
        onCancel={() => {
          setViewModalVisible(false);
          setViewingRecord(null);
        }}
        footer={[
          <Button key="edit" type="primary" onClick={() => {
            setViewModalVisible(false);
            setEditingRecord(viewingRecord);
            form.setFieldsValue(viewingRecord);
            setEditModalVisible(true);
          }}>
            ÁºñËæë
          </Button>,
          <Button key="close" onClick={() => {
            setViewModalVisible(false);
            setViewingRecord(null);
          }}>
            ÂÖ≥Èó≠
          </Button>
        ]}
        width={700}
      >
        {viewingRecord && (
          <div>
            <Descriptions title="Âü∫Êú¨‰ø°ÊÅØ" column={2} bordered>
              <Descriptions.Item label="‰ªìÂ∫ì‰ª£Á†Å">
                <Tag color="blue" style={{ fontWeight: 'bold' }}>
                  {viewingRecord.warehouse_code}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="Áä∂ÊÄÅ">
                <Tag 
                  color={viewingRecord.status === 'active' ? 'success' : 'error'}
                  icon={viewingRecord.status === 'active' ? <CheckCircleOutlined /> : <CloseCircleOutlined />}
                >
                  {viewingRecord.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="Êî∂‰ª∂‰∫∫">
                <Space>
                  <UserOutlined />
                  {viewingRecord.recipient_name}
                </Space>
              </Descriptions.Item>
              <Descriptions.Item label="ÁîµËØù">
                {viewingRecord.phone ? (
                  <Space>
                    <PhoneOutlined />
                    <a href={`tel:${viewingRecord.phone}`}>{viewingRecord.phone}</a>
                  </Space>
                ) : '-'}
              </Descriptions.Item>
            </Descriptions>

            <Divider orientation="left">Âú∞ÂùÄ‰ø°ÊÅØ</Divider>
            <Descriptions column={1} bordered>
              <Descriptions.Item label="Âú∞ÂùÄ‰∏Ä">
                <Space>
                  <EnvironmentOutlined />
                  {viewingRecord.address_line1}
                </Space>
              </Descriptions.Item>
              {viewingRecord.address_line2 && (
                <Descriptions.Item label="Âú∞ÂùÄ‰∫å">
                  <Space>
                    <EnvironmentOutlined />
                    {viewingRecord.address_line2}
                  </Space>
                </Descriptions.Item>
              )}
              <Descriptions.Item label="ÂüéÂ∏Ç/Â∑ûÁúÅ/ÈÇÆÁºñ">
                <Space>
                  <Tag>{viewingRecord.city}</Tag>
                  {viewingRecord.state_province && <Tag>{viewingRecord.state_province}</Tag>}
                  <Tag>{viewingRecord.postal_code}</Tag>
                </Space>
              </Descriptions.Item>
              <Descriptions.Item label="ÂõΩÂÆ∂">
                <Space>
                  <GlobalOutlined />
                  <Tag color="green">{viewingRecord.country}</Tag>
                </Space>
              </Descriptions.Item>
            </Descriptions>

            {viewingRecord.notes && (
              <>
                <Divider orientation="left">Â§áÊ≥®‰ø°ÊÅØ</Divider>
                <Paragraph>
                  {viewingRecord.notes}
                </Paragraph>
              </>
            )}

            <Divider orientation="left">Êó∂Èó¥‰ø°ÊÅØ</Divider>
            <Descriptions column={2} bordered>
              <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥">
                {viewingRecord.created_at ? dayjs(viewingRecord.created_at).format('YYYY-MM-DD HH:mm:ss') : '-'}
              </Descriptions.Item>
              <Descriptions.Item label="Êõ¥Êñ∞Êó∂Èó¥">
                {viewingRecord.updated_at ? dayjs(viewingRecord.updated_at).format('YYYY-MM-DD HH:mm:ss') : '-'}
              </Descriptions.Item>
            </Descriptions>
          </div>
        )}
      </Modal>
    </div>
  );
};

export default WarehouseManagement; 