# 采购发票管理优化说明

## 优化内容概述

根据用户需求，对"采购发票管理"页面进行了三个重要优化：

### 1. 删除独立的"删除截图"按钮
**优化内容**：
- 移除了"关联发票信息"列中的独立"删除截图"按钮
- 删除了相关的前端处理函数 `handleDeleteScreenshots`
- 删除了后端独立删除截图的API接口 `DELETE /invoices/:invoiceId/screenshots`

**原因**：
- 简化界面操作，避免用户困惑
- 统一删除操作，避免数据不一致

### 2. 优化"删除发票"按钮显示逻辑
**优化内容**：
- 当发票有关联截图时，按钮显示"删除发票及截图"
- 当发票没有截图时，按钮显示"删除发票"
- 点击后会同时删除发票文件、截图文件和数据库记录

**实现逻辑**：
```javascript
{invoice.amount_difference_screenshot ? '删除发票及截图' : '删除发票'}
```

**删除流程**：
1. 删除金额差异截图（如果有）
2. 删除发票PDF文件
3. 重置相关订单状态为"未开票"
4. 删除发票数据库记录

### 3. 修复批量开票对话框中删除截图的OSS文件删除问题
**问题描述**：
在"批量开票"对话框的金额差异截图上传区域，点击删除按钮时，只从前端界面移除了截图，但没有删除阿里云OSS中的实际文件。

**修复方案**：
- 增强Upload组件的`onRemove`处理逻辑
- 获取OSS对象名的多种策略：
  1. 从 `file.response.objectName` 获取
  2. 从 `file.response.data.objectName` 获取  
  3. 从代理URL的path参数解析
- 调用后端删除接口删除OSS文件
- 提供详细的错误处理和用户反馈

## 技术实现细节

### 前端优化 (`frontend/src/pages/Products/PurchaseInvoice.tsx`)

#### 删除截图相关代码
```javascript
// 移除的代码
- 删除截图按钮组件
- handleDeleteScreenshots 函数
- 相关的确认对话框
```

#### 动态按钮文本
```javascript
{invoice.amount_difference_screenshot ? '删除发票及截图' : '删除发票'}
```

#### 增强的onRemove处理
```javascript
onRemove={async (file) => {
  try {
    // 获取OSS对象名的多种策略
    let objectName = null;
    if (file.response?.objectName) {
      objectName = file.response.objectName;
    } else if (file.response?.data?.objectName) {
      objectName = file.response.data.objectName;
    } else if (file.url && file.url.includes('screenshot-proxy?path=')) {
      // 从代理URL解析
      const urlObj = new URL(file.url);
      objectName = decodeURIComponent(urlObj.searchParams.get('path') || '');
    }
    
    if (objectName) {
      // 调用后端删除OSS文件
      await fetch(`${API_BASE_URL}/api/purchase-invoice/delete-invoice-file`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ objectName }),
      });
    }
    
    // 从前端状态移除
    setUploadedScreenshots(prev => prev.filter(item => item.uid !== file.uid));
    message.success('截图删除成功');
    
  } catch (error) {
    // 容错处理
    message.warning('截图从界面移除成功，但OSS文件可能删除失败');
  }
  return true;
}
```

### 后端优化 (`backend/routes/purchaseInvoice.js`)

#### 删除的接口
```javascript
// 移除了独立的删除截图接口
- router.delete('/invoices/:invoiceId/screenshots', ...)
```

#### 保留的功能
- 删除发票时自动删除相关截图的逻辑保持不变
- OSS文件删除接口 `DELETE /delete-invoice-file` 被复用于删除截图

## 用户体验改进

### 1. 界面简化
- **之前**：两个按钮（"删除发票"、"删除截图"）
- **现在**：一个智能按钮（根据是否有截图显示不同文本）

### 2. 操作逻辑优化
- **之前**：需要分别删除截图和发票，容易遗漏
- **现在**：一键删除所有相关内容，避免数据残留

### 3. 错误处理增强
- **批量开票对话框**：删除截图时提供详细的成功/失败反馈
- **删除发票**：显示详细的删除结果（发票文件、截图、订单重置等）

## 测试验证

### 测试场景1：删除包含截图的发票
1. 创建订单并开票，上传金额差异截图
2. 确认按钮显示为"删除发票及截图"
3. 点击删除，验证：
   - 发票记录被删除
   - OSS中的发票PDF和截图都被删除
   - 订单状态重置为"未开票"
   - 显示详细的删除结果消息

### 测试场景2：删除没有截图的发票
1. 创建订单并开票，不上传截图
2. 确认按钮显示为"删除发票"
3. 点击删除，验证删除结果

### 测试场景3：批量开票对话框删除截图
1. 进入批量开票流程
2. 上传金额差异截图
3. 点击截图的删除按钮
4. 验证：
   - 截图从界面移除
   - OSS中的截图文件被删除
   - 显示成功消息

## 技术要点

### 1. 容错处理
- OSS删除失败不会阻塞界面操作
- 提供详细的错误日志和用户反馈
- 多种对象名获取策略确保兼容性

### 2. 向后兼容
- 支持历史数据（没有objectName的截图）
- 支持多种URL格式解析

### 3. 数据一致性
- 使用事务确保数据库操作的一致性
- 统一的删除流程避免数据残留

## 服务器状态

后端服务器已重启，所有优化已生效：
- 前端：http://localhost:3000
- 后端：http://localhost:3001

## 重要提醒

1. **测试删除功能**：确保OSS配置正确且有删除权限
2. **观察日志**：检查后端控制台的删除操作日志
3. **验证OSS**：登录阿里云控制台确认文件确实被删除
4. **用户体验**：注意按钮文本的动态变化和详细的操作反馈

这些优化大大简化了用户操作流程，提高了数据一致性，确保了OSS文件的正确清理。 