# Chrome插件部署指南

## 生产环境部署

### 1. 配置生产环境API地址

在部署到生产环境前，需要修改默认的API地址：

**方法一：修改源码（推荐）**
```javascript
// 编辑 background.js 文件，找到以下行：
return 'http://localhost:3001'; // 默认后端地址

// 修改为实际的生产环境地址：
return 'https://your-production-domain.com'; // 生产环境地址
```

**方法二：用户安装后自行设置**
- 用户安装插件后，点击插件图标
- 在弹窗中点击"插件设置"
- 修改"后端API地址"为实际地址

### 2. 打包插件

在Chrome扩展程序页面：
1. 启用开发者模式
2. 点击"打包扩展程序"
3. 选择 `chrome-extension` 文件夹
4. 生成 `.crx` 文件和 `.pem` 密钥文件

### 3. 分发给用户

**选项A：内部服务器托管**
1. 将 `.crx` 文件上传到内部服务器
2. 提供下载链接给用户
3. 用户下载后拖拽到Chrome扩展程序页面安装

**选项B：直接分发源码**
1. 将整个 `chrome-extension` 文件夹打包为ZIP
2. 发送给用户
3. 用户解压后通过"加载已解压的扩展程序"安装

## 后端API配置

确保后端已正确配置以下端点：

### 1. 用户认证端点
```
GET /api/auth/current-user
```
- 用于检查用户登录状态
- 插件会调用此端点验证用户身份

### 2. 页面源代码保存端点
```
POST /api/product_weblink/save-page-source
```
- 用于保存获取的页面源代码
- 接收产品ID、SKU、链接和源代码数据

### 3. CORS配置

确保后端允许Chrome插件的跨域请求：

```javascript
// 在app.js或相关配置文件中添加：
app.use(cors({
  origin: ['chrome-extension://*', 'http://localhost:*', 'https://your-domain.com'],
  credentials: true
}));
```

## 安全配置

### 1. 权限最小化

插件manifest.json中的权限说明：
- `activeTab`: 只访问用户当前活跃的标签页
- `scripting`: 用于获取页面内容
- `storage`: 存储插件设置
- `tabs`: 管理标签页（打开/关闭）

### 2. 内容安全策略

确保后端API支持插件的请求：
- 设置适当的CORS头
- 验证请求来源
- 使用HTTPS传输

## 监控和日志

### 1. 后端日志

在保存页面源代码的API中添加日志：
```javascript
console.log(`产品 ${parentSku} 页面源代码已获取，长度: ${sourceLength} 字符，用户: ${req.user.username}`);
```

### 2. 错误监控

可以在后端添加错误统计：
- 记录插件调用次数
- 统计成功/失败率
- 监控异常情况

## 用户培训

### 1. 安装培训
- 制作安装视频教程
- 提供截图步骤说明
- 设置技术支持联系方式

### 2. 使用培训
- 演示完整的审核流程
- 说明常见问题和解决方案
- 提供操作检查清单

## 故障排除清单

### 管理员检查项目：
- [ ] 后端API端点是否正常工作
- [ ] CORS配置是否正确
- [ ] 数据库连接是否正常
- [ ] 服务器日志是否有错误

### 用户检查项目：
- [ ] 插件是否已安装并启用
- [ ] 是否已登录系统
- [ ] API地址设置是否正确
- [ ] 浏览器是否允许弹出窗口

## 版本更新流程

### 1. 更新插件
1. 修改manifest.json中的版本号
2. 测试新功能
3. 重新打包分发
4. 通知用户更新

### 2. 向下兼容
- 保持API接口的向下兼容性
- 新功能采用渐进式增强
- 提供降级方案

## 技术支持

### 常用调试命令

**检查插件状态：**
```javascript
// 在控制台中运行
chrome.runtime.getManifest()
```

**查看插件日志：**
1. 打开 chrome://extensions/
2. 找到插件，点击"检查视图：后台页面"
3. 在控制台中查看日志

**重置插件设置：**
```javascript
// 在控制台中运行
chrome.storage.sync.clear()
```

## 性能优化

### 1. 批量处理优化
- 限制同时打开的标签页数量（建议5-10个）
- 增加标签页间的延迟时间
- 实现错误重试机制

### 2. 内存管理
- 及时关闭不需要的标签页
- 限制页面源代码保存大小
- 定期清理临时数据

## 备份和恢复

### 1. 配置备份
- 定期备份插件设置
- 保存.pem密钥文件
- 备份源代码版本

### 2. 紧急恢复
- 准备应急版本
- 建立快速回滚机制
- 制定应急联系流程

---

**部署完成后，请进行全面测试以确保所有功能正常工作。** 