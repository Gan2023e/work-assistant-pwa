# 采购发票管理页面优化 - 发票文件查看和上传功能

## 功能描述
在采购发票管理页面中，用户现在可以：
1. 对于有文件的发票：点击"查看"按钮，在新网页中打开并查看上传的发票文件
2. 对于没有文件的发票：显示"无文件"标签，并提供"上传"按钮来补充文件

## 主要改动

### 1. 后端优化（backend/routes/purchaseInvoice.js）
- **发票文件查看接口**：`GET /api/purchase-invoice/invoices/:id/file`
  - 根据发票ID获取发票文件信息
  - 支持OSS文件的签名URL生成（有效期1小时）
  - 兼容直接文件URL访问
  - 返回文件URL、文件名和文件大小信息

- **文件上传接口**：`POST /api/purchase-invoice/invoices/:id/upload-file`
  - 为现有发票补充上传文件
  - 支持PDF文件类型验证
  - 自动上传到OSS存储
  - 更新发票记录的文件信息

### 2. 前端优化（frontend/src/pages/Products/PurchaseInvoice.tsx）
- 新增`EyeOutlined`图标导入
- 新增`handleViewInvoiceFile`函数处理发票文件查看
- 新增`handleUploadFileToInvoice`函数处理文件上传
- 修改表格列配置中的"关联发票信息"列：
  - **有文件的发票**：显示"查看"按钮，可点击查看文件
  - **没有文件的发票**：显示"无文件"标签和"上传"按钮，可补充文件

## 技术实现

### 后端接口设计
```javascript
// 获取发票文件
router.get('/invoices/:id/file', async (req, res) => {
  // 1. 验证发票存在性
  // 2. 检查文件URL是否存在
  // 3. 处理OSS签名URL生成
  // 4. 返回文件访问信息
});

// 上传文件到现有发票
router.post('/invoices/:id/upload-file', upload.single('file'), async (req, res) => {
  // 1. 验证发票存在性
  // 2. 验证文件类型（PDF）
  // 3. 上传文件到OSS
  // 4. 更新发票记录
});
```

### 前端交互设计
```typescript
// 查看发票文件函数
const handleViewInvoiceFile = async (invoiceId: number) => {
  // 1. 调用后端API获取文件URL
  // 2. 在新窗口打开文件
  // 3. 错误处理和用户提示
};

// 上传文件到发票函数
const handleUploadFileToInvoice = async (invoiceId: number) => {
  // 1. 创建文件选择器
  // 2. 上传文件到后端
  // 3. 刷新页面显示
};
```

### 表格列配置优化
```typescript
// 根据是否有文件显示不同的操作按钮
{invoice.invoice_file_url ? (
  <Button
    type="link"
    size="small"
    icon={<EyeOutlined />}
    onClick={() => handleViewInvoiceFile(invoice.id)}
    title="查看发票文件"
  >
    查看
  </Button>
) : (
  <Space>
    <Tag color="default" title="该发票未上传文件">无文件</Tag>
    <Button
      type="link"
      size="small"
      icon={<UploadOutlined />}
      onClick={() => handleUploadFileToInvoice(invoice.id)}
      title="为该发票上传文件"
    >
      上传
    </Button>
  </Space>
)}
```

## 用户体验优化

### 1. 直观的用户界面
- 在发票编号旁边根据文件状态显示不同的操作按钮
- 有文件：显示"查看"按钮（眼睛图标）
- 无文件：显示"无文件"标签和"上传"按钮（上传图标）
- 鼠标悬停时显示提示文本

### 2. 完整的文件管理流程
- **文件查看**：安全的OSS签名URL访问
- **文件补充**：为没有文件的发票提供上传功能
- **实时更新**：上传成功后自动刷新页面显示

### 3. 良好的错误处理
- 发票不存在时返回404错误
- 文件不存在时给出明确提示
- 文件类型验证（仅支持PDF）
- 网络错误时显示用户友好的错误消息

## 使用方法

### 查看发票文件
1. 打开采购发票管理页面
2. 找到已开票的订单记录
3. 在"关联发票信息"列中找到发票编号
4. 点击发票编号旁边的"查看"按钮
5. 系统将在新窗口中打开发票文件

### 上传发票文件
1. 打开采购发票管理页面
2. 找到显示"无文件"标签的发票记录
3. 点击"上传"按钮
4. 选择PDF格式的发票文件
5. 系统自动上传并更新发票记录

## 问题解决

### 针对用户反馈的问题
**问题**：点击发票编号"25132000000118590968"后，没有弹出新页面来显示发票文件

**原因分析**：
- 该发票记录存在于数据库中（ID: 3）
- 但是`invoice_file_url`字段为空，表示没有上传文件
- 原来的代码只在有文件URL时才显示"查看"按钮

**解决方案**：
1. 修改显示逻辑，让用户能够看到所有发票的状态
2. 对于没有文件的发票，显示"无文件"标签
3. 添加"上传"按钮，允许用户补充发票文件
4. 提供完整的文件管理流程

## 注意事项

### 1. 文件访问权限
- 确保OSS配置正确，包括AccessKey权限
- 文件签名URL有效期为1小时
- 如果OSS配置有问题，系统会回退到直接URL访问

### 2. 文件上传限制
- 仅支持PDF文件类型
- 文件大小限制为10MB
- 需要有效的OSS配置才能上传

### 3. 浏览器兼容性
- 使用`window.open()`在新窗口打开文件
- 现代浏览器支持PDF在线预览
- 某些浏览器可能会直接下载文件

### 4. 性能考虑
- 文件URL获取是按需进行的，不会影响列表加载性能
- 签名URL生成是轻量级操作
- 文件上传采用直接上传到OSS的方式

## 测试建议

1. **文件查看测试**：
   - 测试有文件的发票记录点击查看功能
   - 测试OSS签名URL的有效期
   - 测试不同浏览器的文件打开行为

2. **文件上传测试**：
   - 测试PDF文件上传功能
   - 测试文件类型验证
   - 测试上传成功后的页面刷新

3. **状态显示测试**：
   - 测试有文件发票显示"查看"按钮
   - 测试无文件发票显示"无文件"标签和"上传"按钮
   - 测试上传文件后状态变化

4. **错误处理测试**：
   - 测试网络错误情况的错误处理
   - 测试无效文件类型的处理
   - 测试OSS配置错误的处理

## 后续优化建议

1. 可以考虑添加文件预览功能，而不是直接在新窗口打开
2. 可以添加文件下载功能
3. 可以考虑添加文件缩略图预览
4. 可以优化移动端的文件查看体验
5. 可以添加文件版本管理功能 