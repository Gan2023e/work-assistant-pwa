# VAT税单上传功能优化

## 功能概述

本次优化改进了"头程物流管理"页面的VAT税单上传功能，提供了更好的用户体验和信息展示。

## 主要改进

### 1. 上传流程优化
- **点击"上传"按钮**：现在会打开一个对话框，而不是直接上传
- **PDF解析**：选择PDF文件后，系统会自动解析其中的信息
- **信息确认**：解析完成后显示提取的信息，用户可以确认无误后再上传
- **自动上传**：确认后自动上传到阿里云OSS

### 2. 信息展示优化
- **VAT税单列**：现在会显示解析到的关键信息
  - MRN号码（Movement Reference Number）
  - 税金金额
  - 税金日期
- **信息格式**：以清晰的小字体显示在VAT税单列中

### 3. 用户体验改进
- **分步操作**：选择文件 → 解析信息 → 确认上传
- **错误处理**：完善的错误提示和状态管理
- **加载状态**：清晰的上传进度提示

## 技术实现

### 前端改进
1. **新增状态管理**：
   - `vatUploadModalVisible`：对话框显示状态
   - `vatUploadStep`：上传步骤（select/confirm/uploading）
   - `vatExtractedData`：解析到的数据

2. **新增API调用**：
   - `/api/logistics/parse-vat-receipt`：仅解析PDF，不上传
   - 原有的上传API保持不变

3. **UI组件**：
   - 新增VAT税单上传对话框
   - 优化VAT税单列的显示

### 后端改进
1. **新增解析API**：
   - 独立的PDF解析端点
   - 复用现有的`parseVatReceiptPDF`函数

2. **解析功能优化**：
   - **MRN号码提取**：支持OCR字体和特殊字符（如Ø）
   - **税金金额提取**：优先查找Amount Payable列最下方的金额
   - **税金日期提取**：重点查找Place and date部分的日期

## 最新优化内容

### PDF解析算法改进

#### 1. MRN号码提取优化
- **支持特殊字符**：现在可以识别包含Ø等特殊字符的MRN
- **OCR容错处理**：使用更宽松的正则表达式，适应OCR识别可能的错误
- **备用搜索**：如果常规方法失败，会搜索所有可能的25位字符组合
- **长度验证**：支持20-30位字符长度，适应OCR识别误差

#### 2. 税金金额提取优化
- **位置优先**：优先查找文档末尾和Amount Payable相关的金额
- **行尾搜索**：从文档最后几行开始搜索，通常税金金额在右下角
- **金额验证**：只接受合理范围内的金额（0-10000）
- **多模式匹配**：支持多种金额格式和位置

#### 3. 税金日期提取优化
- **Place and date优先**：重点查找包含"Place and date"或"[54]"的行
- **地点日期格式**：支持"地点 日期"格式的识别
- **日期标准化**：自动转换DD/MM/YYYY为YYYY-MM-DD格式
- **备用搜索**：如果特定位置未找到，使用通用日期模式

#### 4. 调试信息增强
- **详细日志**：添加了详细的解析过程日志
- **文本分析**：显示PDF文本的前后1000字符
- **行级调试**：显示文档最后10行的内容
- **匹配过程**：记录每个正则表达式的匹配结果

## 使用流程

1. **打开上传对话框**：点击VAT税单列的"上传"按钮
2. **选择PDF文件**：在对话框中选择VAT税单PDF文件
3. **等待解析**：系统自动解析PDF中的信息
4. **确认信息**：查看解析结果，确认无误
5. **上传文件**：点击"确认上传"按钮完成上传
6. **查看结果**：上传成功后，解析的信息会显示在VAT税单列中

## 支持的信息类型

- **MRN号码**：25位字符的Movement Reference Number（支持特殊字符）
- **税金金额**：Amount Payable列最下方的金额
- **税金日期**：Place and date部分的日期信息

## 注意事项

- 只有目的地为英国的记录才显示VAT税单操作
- 支持PDF格式文件
- 文件大小限制为10MB
- 解析失败时会有相应的错误提示
- 新增了详细的调试日志，便于问题排查

## 技术细节

### MRN提取正则表达式
```javascript
// 支持特殊字符的MRN模式
/([A-Z0-9Ø]{20,30})/i  // 20-30位字符，适应OCR误差
```

### 税金金额提取策略
```javascript
// 优先从文档末尾查找
for (let i = lines.length - 1; i >= 0; i--) {
  // 查找行末的金额
}
```

### 日期提取策略
```javascript
// 优先查找Place and date行
const placeAndDateLine = lines.find(line => 
  line.includes('Place and date') || line.includes('[54]')
);
``` 