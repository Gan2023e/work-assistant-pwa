# SKU删除资料表生成功能升级说明

## 🎯 升级概述
根据用户需求，已将删除资料表生成功能从简单的CSV生成升级为使用现有亚马逊资料模板的高级功能。

## 🔄 升级前后对比

### ❌ 升级前（简单CSV）
- 生成简单的CSV文件
- 只包含3列：`item_sku`, `update_delete`, `sku_type`
- 固定的格式，无法适应不同国家的模板要求
- 不符合亚马逊平台的实际使用需求

### ✅ 升级后（使用亚马逊模板）
- 使用"采购链接管理"页面中保存的亚马逊资料模板
- 保持模板的原有格式和样式
- **从第4行开始填写数据**（符合用户要求）
- 智能识别`item_sku`和`update_delete`列
- 生成Excel格式文件（.xlsx），完全兼容亚马逊平台

## 🚀 功能特性

### 1. 模板自动获取
- 自动调用 `/api/product_weblink/amazon-templates?country=${countryCode}` 获取各国模板列表
- 使用每个国家的第一个可用模板文件
- 支持5个国家：美国(US)、加拿大(CA)、英国(UK)、澳大利亚(AU)、阿联酋(AE)

### 2. 智能列识别
```typescript
// 在模板的前20列中智能查找正确的列
const headerRow = worksheet.getRow(1);
for (let col = 1; col <= 20; col++) {
  const cellValue = headerRow.getCell(col).value?.toString()?.toLowerCase() || '';
  if (cellValue.includes('item') && cellValue.includes('sku')) {
    itemSkuCol = col; // 找到item_sku列
  }
  if (cellValue.includes('update') || cellValue.includes('delete') || cellValue.includes('action')) {
    updateDeleteCol = col; // 找到update_delete列
  }
}
```

### 3. 数据填入规则
- **起始行**: 第4行（符合用户指定要求）
- **item_sku列**: 填入选中的母SKU或子SKU
- **update_delete列**: 统一填入"Delete"
- 保持模板的所有原有格式、公式和样式

### 4. 错误处理机制
- 模板不存在时跳过该国家，记录错误计数
- 下载失败时显示具体错误信息
- 最终显示成功和失败的统计结果

## 🔧 技术实现

### 使用的核心技术
1. **ExcelJS**: 处理Excel文件的读取、修改和生成
2. **Fetch API**: 获取模板列表和下载模板文件
3. **Blob API**: 创建Excel文件的二进制数据
4. **URL.createObjectURL**: 生成下载链接

### 关键代码流程
```typescript
const generateDeleteDataSheet = async () => {
  // 1. 收集选中的SKU数据
  const selectedSkuData = [...];
  
  // 2. 为每个国家处理
  for (const [countryName, countryCode] of Object.entries(countryCodeMap)) {
    // 3. 获取模板文件列表
    const templateResult = await fetch(`${API_BASE_URL}/api/product_weblink/amazon-templates?country=${countryCode}`);
    
    // 4. 下载模板文件
    const fileRes = await fetch(downloadUrl);
    const arrayBuffer = await fileRes.arrayBuffer();
    
    // 5. 使用ExcelJS处理文件
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.load(arrayBuffer);
    
    // 6. 从第4行开始填入数据
    selectedSkuData.forEach((data, index) => {
      const rowNumber = 4 + index;
      const row = worksheet.getRow(rowNumber);
      row.getCell(itemSkuCol).value = data.item_sku;
      row.getCell(updateDeleteCol).value = data.update_delete;
    });
    
    // 7. 生成并下载新文件
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: '...' });
    // 触发下载...
  }
};
```

## 📋 使用流程

### 前提条件
在"采购链接管理"页面的"亚马逊资料模板管理"中，需要预先上传各个国家的亚马逊资料模板文件。

### 操作步骤
1. **选择SKU**: 在Listings管理页面勾选要删除的母SKU和子SKU
2. **点击批量删除**: 点击"批量删除"按钮
3. **配置选项**: 
   - 选择是否删除母SKU记录
   - ✅ **开启生成删除资料表**（默认开启）
4. **确认删除**: 点击"确认删除"按钮
5. **自动下载**: 系统会自动下载每个国家的删除资料表（.xlsx格式）

### 生成的文件
- 文件名格式：`SKU删除资料表_{国家名}_{日期}.xlsx`
- 例如：`SKU删除资料表_美国_2024-01-15.xlsx`

## ✅ 质量保证

### 错误处理
- **模板缺失**: 自动跳过没有模板的国家，显示警告信息
- **下载失败**: 显示具体的错误原因
- **列识别失败**: 使用默认列位置作为备选
- **统计反馈**: 显示成功和失败的国家数量

### 用户体验
- **异步处理**: 不会阻塞UI界面
- **进度反馈**: 实时显示处理结果
- **批量下载**: 所有国家的文件会自动依次下载
- **格式保持**: 完全保持原模板的格式和样式

## 🎉 升级效果

### 用户收益
- ✅ 使用真实的亚马逊资料模板
- ✅ 符合亚马逊平台标准格式
- ✅ 从第4行开始填写数据
- ✅ 保持模板原有样式
- ✅ 支持Excel格式导入
- ✅ 智能列识别，适应不同模板结构

### 系统优势
- 🚀 功能更强大，实用性更高
- 🔧 智能化程度提升
- 📊 完全符合业务需求
- 🛡️ 错误处理更完善
- 💪 技术实现更先进

现在的删除资料表生成功能已经达到企业级应用的标准，完全满足亚马逊平台的实际使用需求！🎊 