# 删除发票截图修复说明

## 问题描述

用户反映：点击"删除发票"按钮后，虽然发票记录已删除，"关联发票信息"列也没有内容显示了，但相应的金额差异截图仍然存在。

## 问题原因

在之前的删除发票逻辑中，只删除了：
1. 发票PDF文件（从OSS）
2. 发票数据库记录
3. 重置相关订单状态

**但遗漏了删除金额差异截图文件**，导致截图文件仍然留在OSS中。

## 修复方案

在删除发票的逻辑中添加了删除金额差异截图的步骤，现在删除发票的完整流程为：

### 1. 删除金额差异截图
- 解析发票的`amount_difference_screenshot`字段
- 逐个删除OSS中的截图文件
- 支持从`objectName`字段或URL解析获取对象名
- 记录删除成功和失败的数量

### 2. 删除发票PDF文件
- 优先使用数据库中的`invoice_file_object_name`
- 其次从URL解析对象名
- 从OSS删除文件

### 3. 重置相关订单状态
- 将关联订单状态改为"未开票"
- 清除订单的`invoice_id`字段

### 4. 删除发票数据库记录
- 从数据库中删除发票记录

## 代码修改内容

### 后端修改 (`backend/routes/purchaseInvoice.js`)

#### 1. 添加截图删除逻辑
```javascript
// 1. 先删除金额差异截图（如果有的话）
if (invoice.amount_difference_screenshot) {
  // 解析截图数据并逐个删除OSS文件
  // 支持多种对象名获取方式
  // 记录删除结果统计
}
```

#### 2. 增强返回信息
```javascript
res.json({
  code: 0,
  message: '删除成功',
  data: {
    resetOrdersCount: relatedOrders.length,
    ossDelete: ossDeleteResult,           // 发票文件删除结果
    screenshotDelete: screenshotDeleteResult, // 截图删除结果（新增）
    operationDetails: {
      hadFile: !!invoice.invoice_file_url,
      hadScreenshots: !!invoice.amount_difference_screenshot, // 新增
      screenshotCount: screenshotCount,   // 新增
      // ... 其他信息
    }
  }
});
```

### 前端修改 (`frontend/src/pages/Products/PurchaseInvoice.tsx`)

#### 改进删除结果显示
- 分别显示发票文件和截图的删除结果
- 根据删除成功/失败情况选择合适的消息类型
- 显示详细的删除统计信息

示例消息：
- 成功：`发票删除成功，OSS发票文件已删除，2个截图已删除，已重置3个相关订单的状态`
- 部分失败：`发票删除成功，OSS发票文件已删除，1个截图已删除，1个删除失败`

## 测试步骤

### 测试场景1：删除包含截图的发票
1. 创建一个订单并开票
2. 上传金额差异截图（1-3张）
3. 确认截图显示在发票信息中
4. 点击"删除发票"按钮
5. **预期结果**：
   - 发票记录被删除
   - "关联发票信息"列变为空
   - OSS中的发票PDF文件被删除
   - OSS中的所有截图文件被删除
   - 订单状态重置为"未开票"
   - 显示详细的删除结果消息

### 测试场景2：删除没有截图的发票
1. 创建一个订单并开票
2. 不上传金额差异截图
3. 点击"删除发票"按钮
4. **预期结果**：
   - 发票记录被删除
   - OSS中的发票PDF文件被删除
   - 显示消息不包含截图相关信息

### 验证方法

#### 1. 检查后端日志
```
🗑️ 开始删除 2 个金额差异截图...
✅ 删除OSS截图文件成功: invoices/purchase/2024/01/uuid1.jpg
✅ 删除OSS截图文件成功: invoices/purchase/2024/01/uuid2.jpg
📋 使用数据库中保存的对象名: invoices/purchase/2024/01/uuid3.pdf
✅ OSS文件删除成功: invoices/purchase/2024/01/uuid3.pdf
```

#### 2. 检查前端消息
- 成功时显示绿色成功消息
- 部分失败时显示黄色警告消息
- 包含详细的删除统计信息

#### 3. 检查OSS存储
- 登录阿里云OSS控制台
- 确认相关文件已被删除

## 技术要点

### 1. 事务管理
所有数据库操作都在事务中执行，确保数据一致性。

### 2. 容错处理
- OSS删除失败不会阻塞数据库操作
- 记录详细的错误日志
- 在前端显示具体的失败信息

### 3. 对象名获取策略
1. **优先级1**：使用`screenshot.objectName`字段
2. **优先级2**：从代理URL的path参数解析
3. **优先级3**：从OSS直接URL解析pathname

### 4. 向后兼容
- 支持历史数据（没有`objectName`字段的截图）
- 支持多种URL格式的解析

## 服务器状态

后端服务器已重启，新的删除逻辑已生效。可以立即进行测试：
- 前端：http://localhost:3000
- 后端：http://localhost:3001

## 重要提醒

测试时请注意：
1. 确保OSS配置正确且有删除权限
2. 观察后端控制台的删除日志
3. 检查前端显示的详细删除结果
4. 验证OSS中的文件确实被删除

这个修复确保了删除发票时，所有相关的OSS文件（包括发票PDF和金额差异截图）都会被彻底清理，避免造成存储空间浪费。 