# 采购发票管理页面优化完成

## 优化内容

### 1. 页面结构优化
- ✅ 将原来的"采购订单管理"和"发票管理"两个Tab页面合并为统一的表格界面
- ✅ 统一数据展示，订单信息和关联发票信息在同一表格中显示
- ✅ 优化用户体验，减少页面切换，提高操作效率

### 2. 业务流程优化
- ✅ 实现了标准的采购发票管理流程：
  1. 下订单后，先在页面录入订单记录
  2. 供应商开好发票后，勾选相关订单并上传发票
  3. 支持一张发票对应多个订单的一对多关系

### 3. PDF自动解析功能
- ✅ 添加了PDF文件上传和自动解析功能
- ✅ 支持从PDF发票中自动提取以下信息：
  - 发票号码
  - 开票日期
  - 发票总金额
  - 开票方（销售方）
  - 收票方（购买方）
  - 税额
  - 税率

### 4. 数据库优化
- ✅ 在发票表中添加了税率字段
- ✅ 保持了采购订单与发票的一对多关系
- ✅ 支持事务性操作，确保数据一致性

### 5. 后端API优化
- ✅ 新增 `/api/purchase-invoice/upload-and-parse-invoice` 接口，支持PDF上传和解析
- ✅ 新增 `/api/purchase-invoice/associate-orders-with-invoice` 接口，支持批量关联订单与发票
- ✅ 使用正则表达式解析PDF文本，提取关键发票信息

### 6. 前端功能优化
- ✅ 统一的订单列表展示，支持搜索和筛选
- ✅ 订单勾选功能，支持批量选择要开票的订单
- ✅ PDF上传和解析，自动填充发票信息
- ✅ 实时统计显示，包括总订单数、未开票订单等
- ✅ 响应式设计，适配不同屏幕尺寸

## 使用方法

### 1. 新增订单
点击"新增订单"按钮，填写订单信息包括：
- 订单编号
- 订单日期
- 卖家公司名
- 买家公司名
- 实付款金额
- 备注信息

### 2. 批量开票
1. 在订单列表中勾选需要开票的订单
2. 点击"批量开票"按钮
3. 上传PDF发票文件（可选，支持自动解析）
4. 检查并补充发票信息
5. 提交保存

### 3. PDF自动解析
- 系统支持解析常见的中文发票格式
- 自动提取发票号、日期、金额、税额、税率等信息
- 解析后会自动填充到表单中，用户可以检查并修改

## 技术实现

### 前端技术
- React + TypeScript
- Ant Design 组件库
- PDF上传和表单处理
- 状态管理和数据流控制

### 后端技术
- Node.js + Express
- Sequelize ORM
- PDF-parse库进行PDF文本解析
- 正则表达式模式匹配
- 事务性数据库操作

### 数据库
- MySQL数据库
- 采购订单表 (purchase_orders)
- 发票表 (invoices)
- 一对多关系约束

## 注意事项

1. PDF解析功能基于文本识别，对于图片化的PDF可能识别效果不佳
2. 系统已配置常见的中文发票格式解析规则，特殊格式可能需要手动录入
3. 建议在生产环境中测试PDF解析功能的准确性
4. 已开票的订单不能再次选择进行开票操作

## 测试建议

1. 测试订单的增删改查功能
2. 测试PDF上传和解析功能
3. 测试批量开票和订单关联功能
4. 测试数据统计和筛选功能
5. 测试异常情况处理（如重复订单号、无效PDF等） 